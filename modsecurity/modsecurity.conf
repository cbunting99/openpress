# ModSecurity configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 524288
SecRequestBodyLimit 134217728
SecRequestBodyNoFilesLimit 1048576
SecRequestBodyInMemoryLimit 1048576
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0
SecAuditEngine RelevantOnly
SecAuditLog /var/log/modsec_audit.log
SecAuditLogFormat JSON
SecAuditLogType Serial
SecAuditLogParts ABIJDEFHZ
SecDataDir /tmp/modsecurity/data
SecTmpDir /tmp/modsecurity/tmp
SecUploadDir /tmp/modsecurity/upload
SecUploadKeepFiles Off

# Default action
SecDefaultAction "phase:1,deny,log"
SecDefaultAction "phase:2,deny,log"

# Include OWASP Core Rule Set
Include /etc/modsecurity/crs-setup.conf
Include /etc/modsecurity/rules/*.conf

# Custom WordPress rules
SecRule REQUEST_FILENAME "@streq /wp-login.php" \
    "id:1001,\
    phase:1,\
    t:none,\
    nolog,\
    pass,\
    chain"
    SecRule IP:BF_BLOCK "@eq 1" \
        "t:none,\
        setvar:ip.bf_counter=0,\
        expirevar:ip.bf_counter=300"

SecRule REQUEST_FILENAME "@streq /wp-login.php" \
    "id:1002,\
    phase:1,\
    t:none,\
    nolog,\
    pass,\
    chain"
    SecRule RESPONSE_STATUS "@streq 200" \
        "t:none,\
        setvar:ip.bf_counter=+1,\
        expirevar:ip.bf_counter=300"

SecRule IP:BF_BLOCK "@eq 1" \
    "id:1003,\
    phase:1,\
    t:none,\
    deny,\
    status:403,\
    log,\
    msg:'Brute force attack detected'"

# Block common attack patterns
SecRule ARGS "@rx <script" \
    "id:1004,\
    phase:2,\
    t:none,\
    deny,\
    status:403,\
    log,\
    msg:'XSS attack detected'"

SecRule ARGS "@rx (select|union|insert|cast|declare|drop|update|md5|benchmark|script|javascript|vbscript|onload|onerror)" \
    "id:1005,\
    phase:2,\
    t:none,\
    deny,\
    status:403,\
    log,\
    msg:'SQL injection attempt detected'"

# Rate limiting for suspicious requests
SecRule &TX:REAL_IP "@eq 0" \
    "id:1006,\
    phase:1,\
    t:none,\
    setvar:tx.real_ip=%{REMOTE_ADDR}"

SecRule TX:REAL_IP "@rx ^(?:10\.|127\.|169\.254\.|172\.(?:1[6-9]|2[0-9]|3[0-1])\.|192\.168\.|::1$)" \
    "id:1007,\
    phase:1,\
    t:none,\
    nolog,\
    pass"

# GeoIP blocking (if enabled)
# SecGeoLookupDb /usr/share/GeoIP/GeoLite2-Country.mmdb
# SecRule GEO:COUNTRY_CODE "@pmFromFile /etc/modsecurity/blocked_countries.txt" \
#     "id:1008,\
#     phase:1,\
#     t:none,\
#     deny,\
#     status:403,\
#     log,\
#     msg:'Access denied from blocked country'"
